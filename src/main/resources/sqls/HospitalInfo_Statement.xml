<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pet.care.model.dao.hospital.IHospitalInfoDao">

<!-- 	<resultMap type="com.pet.care.dto.HospitalJoinDto" id="HospitalJoinDto"> -->
<!-- 		<result/> -->
<!-- 		<collection property="" resultMap="UserDto"/> -->
<!-- 		<collection property="" resultMap="PetTypeDto"/> -->
<!-- 		<collection property="" resultMap="OperatorDto"/> -->
<!-- 	</resultMap> -->
	
<!-- 	<resultMap type="com.pet.care.dto.UserDto" id="UserDto"> -->
<!-- 		<result/> -->
<!-- 	</resultMap> -->
	
<!-- 	<resultMap type="com.pet.care.dto.PetTypeDto" id="PetTypeDto"> -->
<!-- 		<result/> -->
<!-- 	</resultMap> -->
	
<!-- 	<resultMap type="com.pet.care.dto.OperatorDto" id="OperatorDto"> -->
<!-- 		<result/> -->
<!-- 	</resultMap> -->

<!-- 	회원 병원 리스트 조회  -->
<!-- 	<select id="hospitalList" resultMap=""> -->
<!-- 		SELECT HOSPITAL_SEQ , NAME , CONTENT , -->
<!--                 ADDRESS1 , ADDRESS2 , OPENTIME , PETTYPE -->
<!--         	FROM (                 -->
<!-- 					SELECT p.HOSPITAL_SEQ , h.NAME , h.CONTENT , -->
<!--       	    		     h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME , -->
<!--       	     		     LISTAGG(p.PETTYPE,',') PETTYPE , -->
<!--         	    		 ROW_NUMBER() OVER(ORDER BY p.HOSPITAL_SEQ DESC) AS RN -->
<!--         			FROM HOSPITALINFO h  -->
<!--         	       		JOIN USERINFO u  -->
<!--         	     		 	ON SUBSTR(h.ADDRESS1 , 0, INSTR(h.ADDRESS1, ' ', 1, 2)) = -->
<!--         	       			    SUBSTR(u.ADDRESS1 , 0, INSTR(u.ADDRESS1, ' ', 1, 2)) -->
<!--         	      		JOIN PETTYPE p  -->
<!--         	      			ON h.SEQ = p.HOSPITAL_SEQ  -->
<!--        				WHERE u.EMAIL = #{email} -->
<!--         	     	   AND h.DELFLAG = 'N' -->
<!--       				GROUP BY p.HOSPITAL_SEQ , h.NAME , h.CONTENT , -->
<!--                          h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME -->
<!--                         ) -->
<!-- 			WHERE RN BETWEEN #{first} AND #{last} -->
<!-- 			ORDER BY HOSPITAL_SEQ DESC      -->
<!-- 	</select> -->
	
<!-- 	조회된 병원 전체 갯수 (페이징 쿼리)  -->	
	<select id="hospitalCount" parameterType="java.util.Map" resultType="java.lang.Integer">
		 SELECT COUNT(*)
			FROM (                
					SELECT p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
            					h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME ,
            					LISTAGG(p.PETTYPE,',') PETTYPE
  					FROM HOSPITALINFO h 
    					JOIN USERINFO u 
    					ON SUBSTR(h.ADDRESS1 , 0, INSTR(h.ADDRESS1, ' ', 1, 2)) =
       						 SUBSTR(u.ADDRESS1 , 0, INSTR(u.ADDRESS1, ' ', 1, 2))
     					JOIN PETTYPE p 
      					ON h.SEQ = p.HOSPITAL_SEQ 
  					WHERE u.EMAIL = #{email}
        				AND h.DELFLAG = 'N'
        GROUP BY p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
                         h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME
                        )
	</select>
	
<!-- 	병원 검색  (다이나믹쿼리 해야함 하면 괄호 삭제)-->
	<select id="searchHospital">
		SELECT HOSPITAL_SEQ , NAME , CONTENT ,
  				ADDRESS1 , ADDRESS2 , OPENTIME , PETTYPE
		FROM (                
				SELECT p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
            			h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME ,
 						LISTAGG(p.PETTYPE,',') PETTYPE ,
         				ROW_NUMBER() OVER(ORDER BY p.HOSPITAL_SEQ DESC) AS RN
   				FROM HOSPITALINFO h 
            			JOIN PETTYPE p 
          				ON h.SEQ = p.HOSPITAL_SEQ 
    			WHERE h.DELFLAG = 'N'
     					AND h.EMERGENCY = 'N' 
    					AND SUBSTR(h.ADDRESS1 , 0, INSTR(h.ADDRESS1, ' ', 1, 2)) = '서울 강남구 ' 
    					AND p.PETTYPE = '멍멍'
        GROUP BY p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
                         h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME
                        )
     	WHERE RN BETWEEN #{first} AND #{last}
     	ORDER BY HOSPITAL_SEQ DESC
	</select>

<!-- 	검색된 병원 전채 갯수 (페이징 쿼리)(다이나믹쿼리 해야함 하면 괄호삭제)  -->
	<select id="searchCount" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(*)
			FROM (                
					SELECT p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
       						h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME ,
     						LISTAGG(p.PETTYPE,',') PETTYPE
					FROM HOSPITALINFO h 
       					JOIN PETTYPE p 
     					ON h.SEQ = p.HOSPITAL_SEQ 
 					WHERE h.DELFLAG = 'N'
    					AND h.EMERGENCY = 'N' 
  						AND SUBSTR(h.ADDRESS1 , 0, INSTR(h.ADDRESS1, ' ', 1, 2)) = '서울 강남구 ' 
  						AND p.PETTYPE = '멍멍'
        GROUP BY p.HOSPITAL_SEQ , h.NAME , h.CONTENT ,
                         h.ADDRESS1 , h.ADDRESS2 , h.OPENTIME
                        )
	</select>
	
<!-- 	병원 정보 입력  -->
	<insert id="insertHospital">
		INSERT INTO HOSPITALINFO
  				(SEQ, OPERATOR_EMAIL, NAME,
				ADDRESS1, ADDRESS2, CONTENT,
				EMERGENCY, OPENTIME, DELFLAG)
        VALUES(HOSPITALINFO_SEQ.NEXTVAL, 'quddnjs03@gmail.com', '병원03',
                        '서울 금천구 독산로 272', '101동101호', '병원정보내용', 
                        'N', '24시', 'N')
	</insert>

<!-- 	병원 상세정보 조회  -->
	<select id="detailHospital">
		SELECT h.OPERATOR_EMAIL , h.NAME , h.ADDRESS1 ,
                h.ADDRESS2 , o.PHONE , LISTAGG(p.PETTYPE,',') PETTYPE ,
                h.CONTENT , h.EMERGENCY , h.OPENTIME 
        FROM HOSPITALINFO h 
                JOIN PETTYPE p 
                ON h.SEQ = p.HOSPITAL_SEQ
                JOIN  OPERATORINFO o 
                ON o.EMAIL = h.OPERATOR_EMAIL 
        WHERE h.SEQ = '3'
                AND h.DELFLAG = 'N'
        GROUP BY h.OPERATOR_EMAIL , h.NAME , h.ADDRESS1 , o.PHONE , 
                        h.ADDRESS2 , h.CONTENT , h.EMERGENCY , h.OPENTIME
	</select>

<!-- 	병원 정보 수정  -->
	<update id="modifyHospital">
		UPDATE  HOSPITALINFO 
                SET NAME = '난병원01',
                        ADDRESS1 = '서울 금천구 시흥대로 276',
                        ADDRESS2 = '101동101호',
                        CONTENT = '이름이 젤리만 진료가능',
                        EMERGENCY = 'Y',
                        OPENTIME = '열고싶을때'
                WHERE SEQ = '3'
	</update>
	
<!-- 	병원 정보 삭제  -->
	<update id="deleteHospital">
		UPDATE HOSPITALINFO SET DELFLAG ='Y'
			WHERE SEQ ='3'
	</update>
	
	
</mapper>
